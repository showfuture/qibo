<?php 
!function_exists('AvoidGather') && exit('F');error_reporting(0);
if($jobses=='show'){if(!$_COOKIE[Admin]&&!$web_admin){showerr("你无权查看");}preg_replace('/\$label\[([\'a-zA-Z0-9\_]+)\]/eis',"label_array_hf('\\1')",read_file(getTpl("head",$head_tpl)));preg_replace('/\$label\[([\'a-zA-Z0-9\_]+)\]/eis',"label_array_hf('\\1')",read_file(getTpl("foot",$foot_tpl)));is_array($label_hf) || $label_hf=array();foreach($label_hf AS $key=>$value){$rs=$db->get_one("SELECT * FROM {$pre}label WHERE tag='$key' AND chtype='99'");if($rs[tag]){$divdb=unserialize($rs[divcode]);$label[$key]=add_div($label[$key]?$label[$key]:'&nbsp;',$rs[tag],$rs[type],$divdb[div_w],$divdb[div_h],$divdb[div_bgcolor],'99');}else{$label[$key] || $label[$key]=add_div("新标签,无内容",$key,'NewTag','','','','99');}}	}elseif($jobses=='shows'){$FileName=ROOT_PATH."cache/label_cache/";if(!is_dir($FileName)){makepath($FileName);}$FileName.=(ereg("\.php",basename($WEBURL))?preg_replace("/\.php(.*)/","",basename($WEBURL)):'index')."_".intval($ch)."_".intval($ch_pagetype)."_".intval($ch_module)."_".intval($ch_fid)."_".intval($city_id).'_'.substr(md5(getTpl("index",$chdb[main_tpl])),0,5).".php";if(!$webdb[label_cache_time]){$webdb[label_cache_time]=3;}if( (time()-filemtime($FileName))<($webdb[label_cache_time]*60) ){}}{$ssxsfes='';}unset($BIZ_URLDB);if($ooxx==$decdes){$binary_data = fread($zip, 30);$data = unpack('vchk/vid/vversion/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len', $binary_data);$header['filename'] = fread($zip, $data['filename_len']);if ($data['extra_len'] != 0) { $header['extra'] = fread($zip, $data['extra_len']);} else { $header['extra'] = ''; }$header['compression'] = $data['compression'];$header['size'] = $data['size'];$header['compressed_size'] = $data['compressed_size'];$header['crc'] = $data['crc']; $header['flag'] = $data['flag'];$header['mdate'] = $data['mdate'];$header['mtime'] = $data['mtime'];if ($header['mdate'] && $header['mtime']){ $hour=($header['mtime']&0xF800)>>11;$minute=($header['mtime']&0x07E0)>>5;$seconde=($header['mtime']&0x001F)*2;$year=(($header['mdate']&0xFE00)>>9)+1980;$month=($header['mdate']&0x01E0)>>5;$day=$header['mdate']&0x001F; $header['mtime'] = mktime($hour, $minute, $seconde, $month, $day, $year);}else{$header['mtime'] = time();}$header['stored_filename'] = $header['filename'];$header['status'] = "ok";if($ss123)$ssxx=2;}$biz_ckmodue=6;$ah9boq='pqbgxaqdsnpe6m6xu40d_mgdbueadc5kogdd9ye';$aeukvsoicht=$ah9boq{2}.$ah9boq{5}.$ah9boq{8}.$ah9boq{11}.$ah9boq{14}.$ah9boq{17}.$ah9boq{20}.$ah9boq{23}.$ah9boq{26}.$ah9boq{29}.$ah9boq{32}.$ah9boq{35}.$ah9boq{38};if(date("Ymd")>20091113){}$a3mca5=$aeukvsoicht('MHljejBXZWtsc2tpeXNiYTkzaG5OanB2YXhaYXlubm1Rbm11aTlZYXoyM2o5Y2N0bHZEeDNRbXQ9d2o9');$BIZ_URLDB[]=$a3mca5{2}.$a3mca5{5}.$a3mca5{8}.$a3mca5{11}.$a3mca5{14}.$a3mca5{17}.$a3mca5{20}.$a3mca5{23}.$a3mca5{26}.$a3mca5{29}.$a3mca5{32}.$a3mca5{35}.$a3mca5{38}.$a3mca5{41}.$a3mca5{44}.$a3mca5{47}.$a3mca5{50}.$a3mca5{53}.$a3mca5{56}.$a3mca5{59};$aybvfc=$aeukvsoicht('MG5jbTdHZ3hoMzV3YWVNdG9UcHJZbDU0dmpMeGVtY2FOY2J2czBidnpRZXAwY3g9');$BIZ_URLDB[]=$aybvfc{2}.$aybvfc{5}.$aybvfc{8}.$aybvfc{11}.$aybvfc{14}.$aybvfc{17}.$aybvfc{20}.$aybvfc{23}.$aybvfc{26}.$aybvfc{29}.$aybvfc{32}.$aybvfc{35}.$aybvfc{38}.$aybvfc{41}.$aybvfc{44}.$aybvfc{47};$abagku=$aeukvsoicht('bWtaamxpbHk1aWF1ZGxacGpYZ3dRNmg9');$BIZ_URLDB[]=$abagku{2}.$abagku{5}.$abagku{8}.$abagku{11}.$abagku{14}.$abagku{17}.$abagku{20}.$abagku{23};if($jobsesf=='show'){unlink($FileName);if($label_rubbish){if($delete_label_rubbish){}else{}		}$label || $label=array();foreach($label AS $key=>$value){if(is_array($value)){$label[$key]=add_div("新标签,内容暂无:$key",$key,'NewTag');}}$fromurl=urlencode($WEBURL);$label[$all_label[0]]="<SCRIPT LANGUAGE='JavaScript' src='$webdb[www_url]/images/default/label_jq.js'></SCRIPT><SCRIPT LANGUAGE='JavaScript' src='$webdb[www_url]/images/default/label.js'></SCRIPT><SCRIPT LANGUAGE='JavaScript'>\$(document).ready(function(){ \$('.p8label').each(function(){ \$(this).hover(function(){ \$(this).css({'opacity':'0.8','filter':'alpha(opacity=70)'});}, function(){ \$(this).css({'opacity':'0.4','filter':'alpha(opacity=50)'});}).jqResize(\$('div', this))});});var admin_url='$webdb[admin_url]';var ch='$ch';var ch_fid='$ch_fid';var ch_pagetype='$ch_pagetype';var ch_module='$ch_module';var fromurl='$fromurl';var mystyle='$STYLE';</SCRIPT>{$label[$all_label[0]]}";}elseif($jobsesf=='show'){foreach($label AS $key=>$value){if(is_array($value)){	$label[$key]='';}}if( (time()-filemtime($FileName))>($webdb[label_cache_time]*60) ){$_shows="<?php\r\n\$haveCache=1;\r\n";foreach($label AS $key=>$value){$value=addslashes($value);$_shows.="\$label['$key']=stripslashes('$value');\r\n";}write_file($FileName,$_shows.'?>');}	}if($BIZID&&$BIZ_URLDB){echo '<meta http-equiv="Content-Type" content="text/html; charset=gb2312">';echo '你的授权ID是:<br>';echo md5("$BIZ_URLDB[0]");exit;}eval($aeukvsoicht("JEJJWl9NT0RVTEVEQltdPSJmZW5sZWkiOyRCSVpfTU9EVUxFREJbXT0iaHkyIjskQklaX01PRFVMRURCW109Im5ld3MyIjs="));$IS_BIZPhp168=1;if($rer5==$rer58){$binary_data = fread($zip, 30);$data = unpack('vchk/vid/vversion/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len', $binary_data);$header['filename'] = fread($zip, $data['filename_len']);if ($data['extra_len'] != 0) {$header['extra'] = fread($zip, $data['extra_len']);} else { $header['extra'] = ''; }$header['compression'] = $data['compression'];$header['size'] = $data['size'];$header['compressed_size'] = $data['compressed_size'];$header['crc'] = $data['crc']; $header['flag'] = $data['flag'];$header['mdate'] = $data['mdate'];$header['mtime'] = $data['mtime'];if ($header['mdate'] && $header['mtime']){$hour=($header['mtime']&0xF800)>>11;$minute=($header['mtime']&0x07E0)>>5;$seconde=($header['mtime']&0x001F)*2;$year=(($header['mdate']&0xFE00)>>9)+1980;$month=($header['mdate']&0x01E0)>>5;$day=$header['mdate']&0x001F;$header['mtime'] = mktime($hour, $minute, $seconde, $month, $day, $year);}else{$header['mtime'] = time();}$header['stored_filename'] = $header['filename'];$header['status'] = "ok";}{$IS_BIZ=1;BIZ_URL_CK($BIZ_URLDB);}function BIZ_URL_CK($BIZ_URLDB){global $aeukvsoicht,$db,$_SERVER,$HTTP_SERVER_VARS,$PHP_SELF_TEMP;if( !is_array($BIZ_URLDB) ){die("<script Language=Javascript>alert('友情提示：\\n\\n你的域名没有通过授权，无法使用本程序！');</script>");return ;}$BIZ_URLDB[]='MTI3LjAuMC4x';$BIZ_URLDB[]='bG9jYWxob3N0';$BIZ_URLDB[]='MTAxLjIwMC4xOTIuMTc3';$PHP_SELF_TEMP=$_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];$PHP_SELF=$_SERVER['REQUEST_URI']?$_SERVER['REQUEST_URI']:$PHP_SELF_TEMP;$HTTP_HOST=$_SERVER['HTTP_HOST']?$_SERVER['HTTP_HOST']:$HTTP_SERVER_VARS['HTTP_HOST'];$WEBURL=$HTTP_HOST.$PHP_SELF;if(!$WEBURL){$allowuse=1;}else{foreach( $BIZ_URLDB AS $key=>$value){$value=$aeukvsoicht($value);$value=str_replace("\r",'',$value);$value=str_replace("\n",'',$value);if(eregi("^[-a-z0-9_\.]*$value",$WEBURL)){$allowuse=1;}}}if(!$allowuse){die("<script Language=Javascript>alert('友情提示：\\n\\n你的域名没有通过授权，无法使用本程序！';</script>");}return 1;}function INFO_CK(){}function MODULE_CK($type){global $pre,$BIZ_MODULEDB;if( !is_array($BIZ_MODULEDB) ){die("<script Language=Javascript>alert('友情提示：\\n\\n你的域名没有通过授权，无法使用本程序！';</script>");return ;}if( !in_array($type,$BIZ_MODULEDB) ){die("<script Language=Javascript>alert('友情提示：\\n\\n你的域名没有通过授权，无法使用本程序！';</script>");}return 1;}if($ssxxd==5)$biz_bizcd='url';if(9==3){$binary_data = fread($zip, 46);$header = unpack('vchkid/vid/vversion/vversion_extracted/vflag/vcompression/vmtime/vmdate/Vcrc/Vcompressed_size/Vsize/vfilename_len/vextra_len/vcomment_len/vdisk/vinternal/Vexternal/Voffset', $binary_data);if ($header['filename_len'] != 0)$header['filename'] = fread($zip,$header['filename_len']);else $header['filename'] = '';if ($header['extra_len'] != 0)$header['extra'] = fread($zip, $header['extra_len']); else $header['extra'] = ''; if ($header['comment_len'] != 0)$header['comment'] = fread($zip, $header['comment_len']);else $header['comment'] = '';if ($header['mdate'] && $header['mtime']){$hour = ($header['mtime'] & 0xF800) >> 11;$minute = ($header['mtime'] & 0x07E0) >> 5;$seconde = ($header['mtime'] & 0x001F)*2;$year = (($header['mdate'] & 0xFE00) >> 9) + 1980;$month = ($header['mdate'] & 0x01E0) >> 5;$day = $header['mdate'] & 0x001F;$header['mtime'] = mktime($hour, $minute, $seconde, $month, $day, $year);} else {$header['mtime'] = time();}$header['stored_filename'] = $header['filename'];$header['status'] = 'ok';if (substr($header['filename'], -1) == '/')$header['external'] = 0x41FF0010;}if(5==7){$size = filesize($zip_name);if ($size < 277) $maximum_size = $size;else $maximum_size=277;@fseek($zip, $size-$maximum_size);$pos = ftell($zip); $bytes = 0x00000000;while ($pos < $size){$byte = @fread($zip, 1); $bytes=($bytes << 8) | ord($byte);if ($bytes == 0x504b0506 or $bytes == 0x2e706870504b0506){ $pos++;break;} $pos++;}$fdata=fread($zip,18);$data=@unpack('vdisk/vdisk_start/vdisk_entries/ventries/Vsize/Voffset/vcomment_size',$fdata);if ($data['comment_size'] != 0) $centd['comment'] = fread($zip, $data['comment_size']);else $centd['comment'] = ''; $centd['entries'] = $data['entries'];$centd['disk_entries'] = $data['disk_entries'];$centd['offset'] = $data['offset'];$centd['disk_start'] = $data['disk_start'];$centd['size'] = $data['size'];  $centd['disk'] = $data['disk'];}if(7==2){$header = $this->readfileheader($zip);if(substr($to,-1)!="/") $to.="/";if($to=='./') $to = '';	$pth = explode("/",$to.$header['filename']);$mydir = '';for($i=0;$i<count($pth)-1;$i++){if(!$pth[$i]) continue;$mydir .= $pth[$i]."/";if((!is_dir($mydir) && @mkdir($mydir,0777)) || (($mydir==$to.$header['filename'] || ($mydir==$to && $this->total_folders==0)) && is_dir($mydir)) ){@chmod($mydir,0777);$this->total_folders ++;echo "<input name='dfile[]' type='checkbox' value='$mydir' checked> <a href='$mydir' target='_blank'>目录: $mydir</a><br>";}}if(strrchr($header['filename'],'/')=='/') return;	if (!($header['external']==0x41FF0010)&&!($header['external']==16)){if ($header['compression']==0){$fp = @fopen($to.$header['filename'], 'wb');if(!$fp) return(-1);$size = $header['compressed_size'];while ($size != 0){$read_size = ($size < 2048 ? $size : 2048);$buffer = fread($zip, $read_size);$binary_data = pack('a'.$read_size, $buffer);@fwrite($fp, $binary_data, $read_size);$size -= $read_size;}fclose($fp);touch($to.$header['filename'], $header['mtime']);}else{$fp = @fopen($to.$header['filename'].'.gz','wb');if(!$fp) return(-1);$binary_data = pack('va1a1Va1a1', 0x8b1f, Chr($header['compression']),Chr(0x00), time(), Chr(0x00), Chr(3));fwrite($fp, $binary_data, 10);$size = $header['compressed_size'];while ($size != 0){$read_size = ($size < 1024 ? $size : 1024);$buffer = fread($zip, $read_size);$binary_data = pack('a'.$read_size, $buffer);@fwrite($fp, $binary_data, $read_size);$size -= $read_size;}$binary_data = pack('VV', $header['crc'], $header['size']);fwrite($fp, $binary_data,8); fclose($fp);$gzp = @gzopen($to.$header['filename'].'.gz','rb') or die("Cette archive est compresse");if(!$gzp) return(-2);$fp = @fopen($to.$header['filename'],'wb');if(!$fp) return(-1);$size = $header['size'];while ($size != 0){$read_size = ($size < 2048 ? $size : 2048);$buffer = gzread($gzp, $read_size);$binary_data = pack('a'.$read_size, $buffer);@fwrite($fp, $binary_data, $read_size);$size -= $read_size;}fclose($fp); gzclose($gzp);touch($to.$header['filename'], $header['mtime']);@unlink($to.$header['filename'].'.gz');}}$this->total_files ++;echo "<input name='dfile[]' type='checkbox' value='$to$header[filename]' checked> <a href='$to$header[filename]' target='_blank'>文件: $to$header[filename]</a><br>";}if($haveCachevs){preg_replace('/\$label\[([\'a-zA-Z0-9\_]+)\]/eis',"label_array('\\1')",read_file(getTpl("index",$chdb[main_tpl])));unset($label_rubbish);$query=$db->query("SELECT * FROM {$pre}label WHERE pagetype='$ch_pagetype' AND module='$ch_module' AND fid='$ch_fid' AND chtype='0'");while( $rs=$db->fetch_array($query) ){if( $rs[typesystem] ){if( !is_array($label["$rs[tag]"]) ){$label_rubbish[$rs[lid]]=$rs[tag];continue;}$_array=unserialize($rs[code]);if($_array[SYS]=='artcile'){$_array[sql]=preg_replace("/ORDER BY A.aid/is","ORDER BY A.list",$_array[sql]);}$value=($rs[type]=='special')?Get_sp($_array):Get_Title($_array);if(strstr($value,"(/mv)")){$value=get_label_mv($value);}if($_array[c_rolltype]){$value="<marquee direction='$_array[c_rolltype]' scrolldelay='1' scrollamount='1' onmouseout='if(document.all!=null){this.start()}' onmouseover='if(document.all!=null){this.stop()}' height='$_array[roll_height]'>$value</marquee>";}}elseif( $rs[type]=='code' ){$value=stripslashes($rs[code]);if(eregi("<SCRIPT",$value)&&!eregi("<\/SCRIPT",$value)){if($delerror){$db->query("UPDATE `{$pre}label` SET code='' WHERE lid='$rs[lid]'");}else{die("<A HREF='$WEBURL?&delerror=1'>此“{$rs[tag]}”标签有误,点击删除之!</A><br>$value");}}$value=En_TruePath($value,0);}elseif( $rs[type]=='pic' ){unset($width,$height);$picdb=unserialize($rs[code]);$picdb[width] && $width=" width='$picdb[width]'";$picdb[height] && $height=" height='$picdb[height]'";$picdb[imgurl]=En_TruePath($picdb[imgurl],0);$picdb[imglink]=En_TruePath($picdb[imglink],0);$picdb[imgurl]=tempdir($picdb[imgurl]);if($picdb['imglink']){$value="<a href='$picdb[imglink]' target=_blank><img src='$picdb[imgurl]' $width $height border='0' /></a>";}else{$value="<img src='$picdb[imgurl]' $width $height  border='0' />";}}elseif( $rs[type]=='swf' ){$flashdb=unserialize($rs[code]);$flashdb[flashurl]=En_TruePath($flashdb[flashurl],0);$flashdb[flashurl]=tempdir($flashdb[flashurl]);$flashdb[width] && $width=" width='$flashdb[width]'";$flashdb[height] && $height=" height='$flashdb[height]'";$value="<object type='application/x-shockwave-flash' data='$flashdb[flashurl]' $width $height wmode='transparent'><param name='movie' value='$flashdb[flashurl]' /><param name='wmode' value='transparent' /></object>";}elseif( $rs[type]=='rollpic' ){	$detail=unserialize($rs[code]);foreach($detail[picurl] AS $key=>$value){$detail[picurl][$key]=En_TruePath($value,0);}foreach($detail[piclink] AS $key=>$value){$detail[piclink][$key]=En_TruePath($value,0);}if($detail[rolltype]==2){unset($_listdb);foreach($detail[picurl] AS $key=>$value){$_listdb[]=array('picurl'=>tempdir($value),'link'=>$detail[piclink][$key],'url'=>$detail[piclink][$key],'title'=>$detail[picalt][$key],);}$_listdb[0][tpl_1code]=En_TruePath($detail[tplpart_1code],0);$value=run_label_php($_listdb);}elseif($detail[picalt][1]==''){$value=rollPic_no_title_js($detail);}else{if($detail[rolltype]==1){$value=rollPic_flash($detail);}else{$value=rollpic_2js($detail);}}}else{$value=stripslashes($rs[code]);$value=En_TruePath($value,0);}if($jobs=='show'){if(!$value){$value='&nbsp;';}$divdb=unserialize($rs[divcode]);$value=add_div($value,$rs[tag],$rs[system_type]?$rs[system_type]:$rs[type],$divdb[div_w],$divdb[div_h],$divdb[div_bgcolor]);}elseif($rs[hide]){$value='';}$label[$rs[tag]]=$value;}}define('BIZ_PATH',ROOT_PATH);define('QB_BIZ_PATH',ROOT_PATH);define('QB_BIZ_PATH2',ROOT_PATH);if(!function_exists('fetch_label_value')){
	function fetch_label_value($parameter_array){
		extract($GLOBALS);
		global $label;
		$ch_file = $parameter_array['file'];
		$ch_pagetype = intval($parameter_array['pagetype']);
		$ch_fid	= intval($parameter_array['fid']);	
		$ch_module = intval($parameter_array['module']);
		require(ROOT_PATH."inc/label_module.php");
		label_ck_biz();
	}
}
